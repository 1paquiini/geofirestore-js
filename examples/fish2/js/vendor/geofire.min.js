if("undefined"!=typeof module&&"undefined"!=typeof process)var RSVP=require("rsvp");var GeoFire=function(){"use strict";function e(e,n){return{g:n,l:e}}function n(e){return null!==e&&e.hasOwnProperty("l")&&Array.isArray(e.l)&&2===e.l.length?e.l:null}var r=function(e){if(this.cancel=function(){"undefined"!=typeof n&&(n(),n=void 0)},"function"!=typeof e)throw new Error("callback must be a function");var n=e},t=function(r){function t(e){return new RSVP.Promise(function(r,t){i.child(e).once("value",function(e){if(null===e.val())r(null);else{var i=n(e.val());null===i?t("Error: Not a valid geofire object: "+e.val()):r(i)}},function(e){t("Error: Firebase synchronization failed: "+e)})})}if(this.ref=function(){return i},this.set=function(n,r){return d(n),null!==r&&y(r),new RSVP.Promise(function(t,o){function a(e){e?o("Error: Firebase synchronization failed: "+e):t()}if(null===r)i.child(n).remove(a);else{var u=p(r);i.child(n).setWithPriority(e(r,u),u,a)}})},this.get=function(e){return d(e),t(e)},this.remove=function(e){return this.set(e,null)},this.query=function(e){return new F(i,e)},r instanceof Firebase==!1)throw new Error("firebaseRef must be an instance of Firebase");var i=r};t.distance=function(e,n){y(e),y(n);var r=6371,t=w(n[0]-e[0]),i=w(n[1]-e[1]),o=Math.sin(t/2)*Math.sin(t/2)+Math.cos(w(e[0]))*Math.cos(w(n[0]))*Math.sin(i/2)*Math.sin(i/2),a=2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o));return r*a};var i=10,o="0123456789bcdefghjkmnpqrstuvwxyz",a=40007860,u=110574,f=5,c=22*f,s=6378137,l=.00669447819799,h=1e-12;Math.log2=Math.log2||function(e){return Math.log(e)/Math.log(2)};var d=function(e){var n;if("string"!=typeof e?n="key must be a string":0===e.length?n="key cannot be the empty string":1+i+e.length>755?n="key is too long to be stored in Firebase":/[\[\].#$\/\u0000-\u001F\u007F]/.test(e)&&(n="key cannot contain any of the following characters: . # $ ] [ /"),"undefined"!=typeof n)throw new Error("Invalid GeoFire key '"+e+"': "+n)},y=function(e){var n;if("[object Array]"!==Object.prototype.toString.call(e))n="location must be an array";else if(2!==e.length)n="expected array of length 2, got length "+e.length;else{var r=e[0],t=e[1];"number"!=typeof r?n="latitude must be a number":-90>r||r>90?n="latitude must be within the range [-90, 90]":"number"!=typeof t?n="longitude must be a number":(-180>t||t>180)&&(n="longitude must be within the range [-180, 180]")}if("undefined"!=typeof n)throw new Error("Invalid GeoFire location '"+e+"': "+n)},v=function(e){var n;if("string"!=typeof e)n="geohash must be a string";else if(0===e.length)n="geohash cannot be the empty string";else for(var r=0,t=e.length;t>r;++r)-1===o.indexOf(e[r])&&(n='geohash cannot contain "'+e[r]+'"');if("undefined"!=typeof n)throw new Error("Invalid GeoFire geohash '"+e+"': "+n)},m=function(e,n){if("object"!=typeof e)throw new Error("query criteria must be an object");if("undefined"==typeof e.center&&"undefined"==typeof e.radius)throw new Error("radius and/or center must be specified");if(n&&("undefined"==typeof e.center||"undefined"==typeof e.radius))throw new Error("query criteria for a new query must contain both a center and a radius");for(var r in e)if(e.hasOwnProperty(r)&&"center"!==r&&"radius"!==r)throw new Error("Unexpected attribute '"+r+"'' found in query criteria");if("undefined"!=typeof e.center&&y(e.center),"undefined"!=typeof e.radius){if("number"!=typeof e.radius)throw new Error("radius must be a number");if(e.radius<0)throw new Error("radius must be greater than or equal to 0")}},w=function(e){if("number"!=typeof e)throw new Error("Error: degrees must be a number");return e*Math.PI/180},p=function(e,n){if(y(e),"undefined"!=typeof n){if("number"!=typeof n)throw new Error("precision must be a number");if(0>=n)throw new Error("precision must be greater than 0");if(n>22)throw new Error("precision cannot be greater than 22");if(Math.round(n)!==n)throw new Error("precision must be an integer")}n=n||i;for(var r={min:-90,max:90},t={min:-180,max:180},a="",u=0,f=0,c=1;a.length<n;){var s=c?e[1]:e[0],l=c?t:r,h=(l.min+l.max)/2;s>h?(u=(u<<1)+1,l.min=h):(u=(u<<1)+0,l.max=h),c=!c,4>f?f++:(f=0,a+=o[u],u=0)}return a},g=function(e,n){var r=w(n),t=Math.cos(r)*s*Math.PI/180,i=1/Math.sqrt(1-l*Math.sin(r)*Math.sin(r)),o=t*i;return h>o?e>0?360:0:Math.min(360,e/o)},b=function(e,n){var r=g(e,n);return Math.abs(r)>1e-6?Math.max(1,Math.log2(360/r)):1},M=function(e){return Math.min(Math.log2(a/2/e),c)},E=function(e){if(180>=e&&e>=-180)return e;var n=e+180;return n>0?n%360-180:180- -n%360},k=function(e,n){var r=n/u,t=Math.min(90,e[0]+r),i=Math.max(-90,e[0]-r),o=2*Math.floor(M(n)),a=2*Math.floor(b(n,t))-1,f=2*Math.floor(b(n,i))-1;return Math.min(o,a,f,c)},x=function(e,n){var r=n/u,t=Math.min(90,e[0]+r),i=Math.max(-90,e[0]-r),o=g(n,t),a=g(n,i),f=Math.max(o,a);return[[e[0],e[1]],[e[0],E(e[1]-f)],[e[0],E(e[1]+f)],[t,e[1]],[t,E(e[1]-f)],[t,E(e[1]+f)],[i,e[1]],[i,E(e[1]-f)],[i,E(e[1]+f)]]},_=function(e,n){v(e);var r=Math.ceil(n/f);if(e.length<r)return[e,e+"~"];e=e.substring(0,r);var t=e.substring(0,e.length-1),i=o.indexOf(e.charAt(e.length-1)),a=n-t.length*f;if(0===a)return[t,t+"~"];var u=f-a,c=i>>u<<u,s=c+(1<<u);return s>31?[t+o[c],t+"~"]:[t+o[c],t+o[s]]},O=function(e,n){y(e);var r=Math.max(1,k(e,n)),t=Math.ceil(r/f),i=x(e,n),o=i.map(function(e){return _(p(e,t),r)});return o.filter(function(e,n){return!o.some(function(r,t){return n>t&&e[0]===r[0]&&e[1]===r[1]})})},F=function(e,o){function a(e,n,r,t){_[e].forEach(function(e){"undefined"==typeof r||null===r?e(n,null,null):e(n,r,t)})}function u(){_.ready.forEach(function(e){e()})}function f(e){var n=e.split(":");if(2!==n.length)throw new Error("Invalid internal state! Not a valid geohash query: "+e);return n}function c(e){if(2!==e.length)throw new Error("Not a valid geohash query: "+e);return e[0]+":"+e[1]}function s(e){var n=x.startAt(e[0]).endAt(e[1]);n.off("child_added",w),n.off("child_removed",b),n.off("child_changed",g)}function l(){for(var e in I)if(I.hasOwnProperty(e)&&I[e]===!1){var n=f(e);s(n),delete I[e]}for(var r in P)if(P.hasOwnProperty(r)&&!d(P[r].geohash)){if(P[r].isInQuery)throw new Error("Internal State error, trying to remove location that is still in query");delete P[r]}q=!1,null!==Q&&(clearTimeout(Q),Q=null)}function h(e,n){y(n);var r,o,u=P.hasOwnProperty(e)?P[e].isInQuery:!1,f=P.hasOwnProperty(e)?P[e].location:null;r=t.distance(n,j),o=C>=r,P[e]={location:n,distanceFromCenter:r,isInQuery:o,geohash:p(n,i)},o&&u===!1?a("key_entered",e,n,r):!o||null===f||n[0]===f[0]&&n[1]===f[1]?o===!1&&u&&a("key_exited",e,n,r):a("key_moved",e,n,r)}function d(e){for(var n in I)if(I.hasOwnProperty(n)){var r=f(n);if(e>=r[0]&&e<=r[1])return!0}return!1}function v(e,n){var r=P[e];if(delete P[e],r&&r.isInQuery){var i=n?t.distance(n,j):null;a("key_exited",e,n,i)}}function w(e){var r=n(e.val());null!==r&&h(e.name(),r)}function g(e){var r=n(e.val());null!==r&&h(e.name(),r)}function b(e){var r=e.name();P.hasOwnProperty(r)&&x.child(r).once("value",function(e){var t=n(e.val()),i=null!==t?p(t):null;d(i)||v(r,t)})}function M(e){var n=k.indexOf(e);n>-1&&k.splice(n,1),F=0===k.length,F&&u()}function E(){var e=O(j,1e3*C).map(c);e=e.filter(function(n,r){return e.indexOf(n)===r});for(var n in I)if(I.hasOwnProperty(n)){var r=e.indexOf(n);-1===r?I[n]=!1:(I[n]=!0,e.splice(r,1))}q===!1&&Object.keys(I).length>25&&(q=!0,Q=setTimeout(l,10)),k=e.slice(),e.forEach(function(e){var n=f(e),r=x.startAt(n[0]).endAt(n[1]);I[e]=!0,r.on("child_added",w),r.on("child_removed",b),r.on("child_changed",g),r.once("value",function(){M(e)})})}if(this.center=function(){return j},this.radius=function(){return C},this.updateCriteria=function(e){m(e),j=e.center||j,C=e.radius||C;for(var n in P)if(P.hasOwnProperty(n)){var r=P[n],i=r.isInQuery;r.distanceFromCenter=t.distance(r.location,j),r.isInQuery=r.distanceFromCenter<=C,i&&!r.isInQuery?a("key_exited",n,r.location,r.distanceFromCenter):!i&&r.isInQuery&&a("key_entered",n,r.location,r.distanceFromCenter)}F=!1,E()},this.on=function(e,n){if(-1===["ready","key_entered","key_exited","key_moved"].indexOf(e))throw new Error('event type must be "ready", "key_entered", "key_exited", or "key_moved"');if("function"!=typeof n)throw new Error("callback must be a function");if(_[e].push(n),"key_entered"===e)for(var t in P)if(P.hasOwnProperty(t)){var i=P[t];i.isInQuery&&n(t,i.location,i.distanceFromCenter)}return"ready"===e&&F&&n(),new r(function(){_[e].splice(_[e].indexOf(n),1)})},this.cancel=function(){_={ready:[],key_entered:[],key_exited:[],key_moved:[]};for(var e in I)if(I.hasOwnProperty(e)){var n=f(e);s(n),delete I[e]}P={},clearInterval(A)},e instanceof Firebase==!1)throw new Error("firebaseRef must be an instance of Firebase");var k,x=e,_={ready:[],key_entered:[],key_exited:[],key_moved:[]},F=!1,P={},I={},q=!1,Q=null,A=setInterval(function(){q===!1&&l()},1e4);m(o,!0);var j=o.center,C=o.radius;E()};return t}();"undefined"!=typeof module&&"undefined"!=typeof process&&(module.exports=GeoFire);