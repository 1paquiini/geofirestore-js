if("undefined"!=typeof module&&"undefined"!=typeof process)var Firebase=require("firebase"),RSVP=require("rsvp");var GeoFire=function(){"use strict";var e=function(e){if(this.cancel=function(){"undefined"!=typeof n&&(n(),n=void 0)},"function"!=typeof e)throw new Error("callback must be a function");var n=e},n=function(e){function n(e,n){return new RSVP.Promise(function(t,i){a.child("l/"+e).once("value",function(o){var u=o.val();null===u?t(null!==n):null!==n&&n[0]===u[0]&&n[1]===u[1]?t(!1):a.child("i/"+v(u,r)+":"+e).remove(function(e){e?i("Error: Firebase synchronization failed: "+e):t(!0)})},function(e){i("Error: Firebase synchronization failed: "+e)})})}function t(e,n){return new RSVP.Promise(function(r,t){a.child("l/"+e).set(n,function(e){e?t("Error: Firebase synchronization failed: "+e):r()})})}function i(e,n){return new RSVP.Promise(function(t,i){null===n?t():a.child("i/"+v(n,r)+":"+e).set(!0,function(e){e?i("Error: Firebase synchronization failed: "+e):t()})})}function o(e){return new RSVP.Promise(function(n,r){a.child("l/"+e).once("value",function(e){n(e.val())},function(e){r("Error: Firebase synchronization failed: "+e)})})}if(this.ref=function(){return a},this.set=function(e,r){return l(e),null!==r&&h(r),n(e,r).then(function(n){return n===!0?new RSVP.all([t(e,r),i(e,r)]):new RSVP.Promise(function(e){e()})})},this.get=function(e){return l(e),o(e)},this.remove=function(e){return this.set(e,null)},this.query=function(e){return new F(a,e)},e instanceof Firebase==!1)throw new Error("firebaseRef must be an instance of Firebase");var a=e};n.distance=function(e,n){h(e),h(n);var r=6371,t=m(n[0]-e[0]),i=m(n[1]-e[1]),o=Math.sin(t/2)*Math.sin(t/2)+Math.cos(m(e[0]))*Math.cos(m(n[0]))*Math.sin(i/2)*Math.sin(i/2),a=2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o));return r*a};var r=10,t="0123456789bcdefghjkmnpqrstuvwxyz",i=40007860,o=110574,a=5,u=22*a,f=6378137,s=.00669447819799,c=1e-12;Math.log2=Math.log2||function(e){return Math.log(e)/Math.log(2)};var l=function(e){var n;if("string"!=typeof e?n="key must be a string":0===e.length?n="key cannot be the empty string":1+r+e.length>755?n="key is too long to be stored in Firebase":/[\[\].#$\/\u0000-\u001F\u007F]/.test(e)&&(n="key cannot contain any of the following characters: . # $ ] [ /"),"undefined"!=typeof n)throw new Error("Invalid GeoFire key '"+e+"': "+n)},h=function(e){var n;if("[object Array]"!==Object.prototype.toString.call(e))n="location must be an array";else if(2!==e.length)n="expected array of length 2, got length "+e.length;else{var r=e[0],t=e[1];"number"!=typeof r||isNaN(r)?n="latitude must be a number":-90>r||r>90?n="latitude must be within the range [-90, 90]":"number"!=typeof t||isNaN(t)?n="longitude must be a number":(-180>t||t>180)&&(n="longitude must be within the range [-180, 180]")}if("undefined"!=typeof n)throw new Error("Invalid GeoFire location '"+e+"': "+n)},d=function(e){var n;if("string"!=typeof e)n="geohash must be a string";else if(0===e.length)n="geohash cannot be the empty string";else for(var r=0,i=e.length;i>r;++r)-1===t.indexOf(e[r])&&(n='geohash cannot contain "'+e[r]+'"');if("undefined"!=typeof n)throw new Error("Invalid GeoFire geohash '"+e+"': "+n)},y=function(e,n){if("object"!=typeof e)throw new Error("query criteria must be an object");if("undefined"==typeof e.center&&"undefined"==typeof e.radius)throw new Error("radius and/or center must be specified");if(n&&("undefined"==typeof e.center||"undefined"==typeof e.radius))throw new Error("query criteria for a new query must contain both a center and a radius");for(var r in e)if(e.hasOwnProperty(r)&&"center"!==r&&"radius"!==r)throw new Error("Unexpected attribute '"+r+"'' found in query criteria");if("undefined"!=typeof e.center&&h(e.center),"undefined"!=typeof e.radius){if("number"!=typeof e.radius||isNaN(e.radius))throw new Error("radius must be a number");if(e.radius<0)throw new Error("radius must be greater than or equal to 0")}},m=function(e){if("number"!=typeof e||isNaN(e))throw new Error("Error: degrees must be a number");return e*Math.PI/180},v=function(e,n){if(h(e),"undefined"!=typeof n){if("number"!=typeof n||isNaN(n))throw new Error("precision must be a number");if(0>=n)throw new Error("precision must be greater than 0");if(n>22)throw new Error("precision cannot be greater than 22");if(Math.round(n)!==n)throw new Error("precision must be an integer")}n=n||r;for(var i={min:-90,max:90},o={min:-180,max:180},a="",u=0,f=0,s=1;a.length<n;){var c=s?e[1]:e[0],l=s?o:i,d=(l.min+l.max)/2;c>d?(u=(u<<1)+1,l.min=d):(u=(u<<1)+0,l.max=d),s=!s,4>f?f++:(f=0,a+=t[u],u=0)}return a},p=function(e,n){var r=m(n),t=Math.cos(r)*f*Math.PI/180,i=1/Math.sqrt(1-s*Math.sin(r)*Math.sin(r)),o=t*i;return c>o?e>0?360:0:Math.min(360,e/o)},w=function(e,n){var r=p(e,n);return Math.abs(r)>1e-6?Math.max(1,Math.log2(360/r)):1},b=function(e){return Math.min(Math.log2(i/2/e),u)},g=function(e){if(180>=e&&e>=-180)return e;var n=e+180;return n>0?n%360-180:180- -n%360},M=function(e,n){var r=n/o,t=Math.min(90,e[0]+r),i=Math.max(-90,e[0]-r),a=2*Math.floor(b(n)),f=2*Math.floor(w(n,t))-1,s=2*Math.floor(w(n,i))-1;return Math.min(a,f,s,u)},E=function(e,n){var r=n/o,t=Math.min(90,e[0]+r),i=Math.max(-90,e[0]-r),a=p(n,t),u=p(n,i),f=Math.max(a,u);return[[e[0],e[1]],[e[0],g(e[1]-f)],[e[0],g(e[1]+f)],[t,e[1]],[t,g(e[1]-f)],[t,g(e[1]+f)],[i,e[1]],[i,g(e[1]-f)],[i,g(e[1]+f)]]},k=function(e,n){d(e);var r=Math.ceil(n/a);if(e.length<r)return[e,e+"~"];e=e.substring(0,r);var i=e.substring(0,e.length-1),o=t.indexOf(e.charAt(e.length-1)),u=n-i.length*a;if(0===u)return[i,i+"~"];var f=a-u,s=o>>f<<f,c=s+(1<<f);return c>31?[i+t[s],i+"~"]:[i+t[s],i+t[c]]},x=function(e,n){h(e);var r=Math.max(1,M(e,n)),t=Math.ceil(r/a),i=E(e,n),o=i.map(function(e){return k(v(e,t),r)});return o.filter(function(e,n){return!o.some(function(r,t){return n>t&&e[0]===r[0]&&e[1]===r[1]})})},F=function(t,i){function o(e,n){var r=E[n];b[e].forEach(function(e){"undefined"==typeof r?e(n,null,null):e(n,r.location,r.distanceFromCenter)})}function a(){b.ready.forEach(function(e){e()})}function u(e){var n=e.split(":");if(2!==n.length)throw new Error("Invalid internal state! Not a valid geohash query: "+e);return n}function f(e){if(2!==e.length)throw new Error("Not a valid geohash query: "+e);return e[0]+":"+e[1]}function s(){for(var e in k)if(k.hasOwnProperty(e)&&k[e]===!1){var n=u(e);w.child("i").startAt(null,n[0]).endAt(null,n[1]).off("child_added",c),delete k[e];for(var r in E)E.hasOwnProperty(r)&&"undefined"!=typeof E[r].geohash&&E[r].geohash>=n[0]&&E[r].geohash<=n[1]&&(w.child("l/"+r).off("value",l),delete E[r])}F=!1,null!==P&&(clearTimeout(P),P=null)}function c(e){g===!1&&M++;var n=e.name().split(":").splice(1).join(":");"undefined"==typeof E[n]&&(E[n]={isInQuery:!1},w.child("l/"+n).on("value",l))}function l(e){var t,i,u=e.name(),f=e.val();E[u].isInQuery===!1?null===f?(w.child("l/"+u).off("value",l),delete E[u]):(t=n.distance(f,I),i=O>=t,E[u]={location:f,distanceFromCenter:t,isInQuery:i,geohash:v(f,r)},i&&o("key_entered",u),M>0&&(M--,g&&0===M&&a())):null===f?(w.child("l/"+u).off("value",l),delete E[u],o("key_exited",u)):(f[0]!==E[u].location[0]||f[1]!==E[u].location[1])&&(t=n.distance(f,I),i=O>=t,E[u]={location:f,distanceFromCenter:t,isInQuery:i,geohash:v(f,r)},i?o("key_moved",u):o("key_exited",u))}function h(){p++,g=p===m.length,g&&0===M&&a()}function d(){m=x(I,1e3*O).map(f),m=m.filter(function(e,n){return m.indexOf(e)===n});for(var e in k)if(k.hasOwnProperty(e)){var n=m.indexOf(e);-1===n?k[e]=!1:(k[e]=!0,m.splice(n,1))}F===!1&&Object.keys(k).length>25&&(F=!0,P=setTimeout(s,10)),p=0,m.forEach(function(e){var n=u(e),r=w.child("i").startAt(null,n[0]).endAt(null,n[1]);k[e]=!0,r.on("child_added",c),r.once("value",h)})}if(this.center=function(){return I},this.radius=function(){return O},this.updateCriteria=function(e){y(e),I=e.center||I,O=e.radius||O;for(var r in E)if(E.hasOwnProperty(r)){var t=E[r];if("undefined"!=typeof t.location){var i=t.isInQuery;t.distanceFromCenter=n.distance(t.location,I),t.isInQuery=t.distanceFromCenter<=O,i&&!t.isInQuery?o("key_exited",r):!i&&t.isInQuery&&o("key_entered",r)}}g=!1,M=0,d()},this.on=function(n,r){if(-1===["ready","key_entered","key_exited","key_moved"].indexOf(n))throw new Error('event type must be "ready", "key_entered", "key_exited", or "key_moved"');if("function"!=typeof r)throw new Error("callback must be a function");if(b[n].push(r),"key_entered"===n)for(var t in E)if(E.hasOwnProperty(t)){var i=E[t];i.isInQuery&&r(t,i.location,i.distanceFromCenter)}return"ready"===n&&g&&r(),new e(function(){b[n].splice(b[n].indexOf(r),1)})},this.cancel=function(){b={ready:[],key_entered:[],key_exited:[],key_moved:[]};for(var e in k)if(k.hasOwnProperty(e)){var n=u(e);w.child("i").startAt(null,n[0]).endAt(null,n[1]).off("child_added",c),delete k[e]}for(var r in E)E.hasOwnProperty(r)&&(w.child("l/"+r).off("value",l),delete E[r]);clearInterval(_)},t instanceof Firebase==!1)throw new Error("firebaseRef must be an instance of Firebase");var m,p,w=t,b={ready:[],key_entered:[],key_exited:[],key_moved:[]},g=!1,M=0,E={},k={},F=!1,P=null,_=setInterval(function(){F===!1&&s()},1e4);y(i,!0);var I=i.center,O=i.radius;d()};return n}();"undefined"!=typeof module&&"undefined"!=typeof process&&(module.exports=GeoFire);