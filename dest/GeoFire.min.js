var GeoFire=function(){"use strict";var e=function(e){return e*Math.PI/180},t=function(t,i){var n,r,o=t[0],a=t[1],s=i[0],c=i[1],u=6371,f=e(s-o),l=e(c-a);return n=Math.sin(f/2)*Math.sin(f/2)+Math.cos(e(o))*Math.cos(e(s))*Math.sin(l/2)*Math.sin(l/2),r=2*Math.atan2(Math.sqrt(n),Math.sqrt(1-n)),u*r},i=function(e,t){var i={min:-90,max:90},n={min:-180,max:180},r=e[0],o=e[1],a="",s=0,c=0,u=1;if(t=Math.min(t||12,22),r<i.min||r>i.max)throw"Invalid latitude specified! ("+r+")";if(o<n.min||o>n.max)throw"Invalid longitude specified! ("+o+")";for(;a.length<t;){var f=u?o:r,l=u?n:i,h=(l.min+l.max)/2;f>h?(s=(s<<1)+1,l.min=h):(s=(s<<1)+0,l.max=h),u=!u,4>c?c++:(c=0,a+="0123456789bcdefghjkmnpqrstuvwxyz"[s],s=0)}return a},n=function(e){return new RSVP.Promise(function(t,i){var n;"string"!=typeof e&&"number"!=typeof e&&(n="key must be a string or a number"),void 0!==n?i("Error: Invalid key '"+e+"': "+n):t()})},r=function(e){return new RSVP.Promise(function(t,i){var n;if(null===e&&t(),e instanceof Array&&2===e.length){var r=e[0],o=e[1];"number"!=typeof r||-90>r||r>90?n="latitude must be a number within the range [-90, 90]":("number"!=typeof o||-180>o||o>180)&&(n="longitude must be a number within the range [-180, 180]")}else n="expected 2 values, got "+e.length;void 0!==n?i("Erorr: Invalid location ["+e+"]: "+n):t()})},o=function(e,t,n){return new RSVP.Promise(function(r,o){null===n&&r(),e.child("indices/"+i(n,12)).set(t,function(e){e?o("Error: Firebase synchronization failed: "+e):r()})})},a=function(e,t,n,r){var o=function(){return new RSVP.Promise(function(n,o){void 0!==r[t]?e.child("indices/"+i(r[t].split(",").map(Number),12)).remove(function(e){e?o("Error: Firebase synchronization failed: "+e):n()}):n()}.bind(this))},a=function(){return new RSVP.Promise(function(i,r){e.child("locations/"+t).set(n?n.toString():null,function(e){e?r("Error: Firebase synchronization failed: "+e):i()})})};return o().then(function(){return a()})},s=function(e){if("function"!=typeof e)throw new Error("GeoCallbackRegistration.cancel() callback must be a function.");this._cancelCallback=e};s.prototype.cancel=function(){this._cancelCallback(),delete this._cancelCallback};var c=function(e,t){if("undefined"==typeof t.center)throw new Error('No "center" attribute specified for query criteria.');if("undefined"==typeof t.radius)throw new Error('No "radius" attribute specified for query criteria.');this._saveQueryCriteria(t),this._firebaseRef=e,this._callbacks={key_entered:[],key_left:[],key_moved:[]},this._locationsInQuery={},this._allLocations={},this._firebaseRef.child("indices").on("child_added",function(e){var t=e.val();this._firebaseRef.child("locations/"+t).once("value",function(e){var i=e.val().split(",").map(Number);this._allLocations[t]=i,this._fireCallbacks(t,i)}.bind(this))}.bind(this)),this._firebaseRef.child("locations").on("child_removed",function(e){var t=e.name();void 0!==this._locationsInQuery[t]&&(this._callbacks.key_left.forEach(function(e){e(t,this._allLocations[t])}.bind(this)),delete this._allLocations[t])}.bind(this))};c.prototype._fireCallbacks=function(e,i){var n=void 0!==this._locationsInQuery[e],r=t(i,this._center)<=this._radius;!n&&r?(this._callbacks.key_entered.forEach(function(t){t(e,i)}),this._locationsInQuery[e]=i):n&&!r?(this._callbacks.key_left.forEach(function(t){t(e,i)}),delete this._locationsInQuery[e]):n&&(this._callbacks.key_moved.forEach(function(t){t(e,i)}),this._locationsInQuery[e]=i)},c.prototype.getResults=function(){return new RSVP.Promise(function(e){var t=[];for(var i in this._locationsInQuery)this._locationsInQuery.hasOwnProperty(i)&&t.push({key:i,location:this._locationsInQuery[i]});e(t)}.bind(this))},c.prototype.on=function(e,t){if(-1===["key_entered","key_left","key_moved"].indexOf(e))throw new Error('Event type must be "key_entered", "key_left", or "key_moved"');if("function"!=typeof t)throw new Error("Event callback must be a function.");if(this._callbacks[e].push(t),"key_entered"===e)for(var i in this._locationsInQuery)this._locationsInQuery.hasOwnProperty(i)&&t(i,this._locationsInQuery[i]);return new s(function(){this._callbacks[e].splice(this._callbacks[e].indexOf(t),1)}.bind(this))},c.prototype.cancel=function(){this._callbacks={key_entered:[],key_left:[],key_moved:[]},this._firebaseRef.child("indices").off(),this._firebaseRef.child("locations").off()},c.prototype.updateQueryCriteria=function(e){this._saveQueryCriteria(e);for(var t in this._allLocations)this._allLocations.hasOwnProperty(t)&&this._fireCallbacks(t,this._allLocations[t])},c.prototype.getCenter=function(){return this._center},c.prototype.getRadius=function(){return this._radius},c.prototype._saveQueryCriteria=function(e){for(var t in e)if(e.hasOwnProperty(t)&&"center"!==t&&"radius"!==t)throw new Error('Unexpected "'+t+'" attribute found in query criteria.');if("undefined"!=typeof e.center){if(!(e.center instanceof Array&&2===e.center.length))throw new Error('Invalid "center" attribute specified for query criteria. Expected array of length 2, got '+e._center.length);var n=e.center[0],r=e.center[1];if("number"!=typeof n||-90>n||n>90)throw new Error('Invalid "center" attribute specified for query criteria. Latitude must be a number within the range [-90, 90]');if("number"!=typeof r||-180>r||r>180)throw new Error('Invalid "center" attribute specified for query criteria. Longitude must be a number within the range [-180, 180]')}if("undefined"!=typeof e.radius&&("number"!=typeof e.radius||e.radius<0))throw new Error('Invalid "radius" attribute specified for query criteria. Radius must be a number greater than or equal to 0.');this._center=e.center,this._centerHash=i(e.center,12),this._radius=e.radius};var u=function(e){this._firebaseRef=e,this._allLocations={},this._firebaseRef.child("locations").on("child_added",function(e){this._allLocations[e.name()]=e.val()}.bind(this)),this._firebaseRef.child("locations").on("child_removed",function(e){delete this._allLocations[e.name()]}.bind(this))};return u.prototype.set=function(e,t){return RSVP.all([n(e),r(t)]).then(function(){return a(this._firebaseRef,e.toString(),t,this._allLocations)}.bind(this)).then(function(){return o(this._firebaseRef,e.toString(),t)}.bind(this))},u.prototype.get=function(e){return n(e).then(function(){return new RSVP.Promise(function(t,i){this._firebaseRef.child("locations/"+e.toString()).once("value",function(e){t(e.val()?e.val().split(",").map(Number):null)},function(e){i("Error: Firebase synchronization failed: "+e)})}.bind(this))}.bind(this))},u.prototype.remove=function(e){return this.set(e,null)},u.prototype.query=function(e){return new c(this._firebaseRef,e)},u}();"undefined"!=typeof module&&(module.exports=GeoFire);