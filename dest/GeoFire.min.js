var GeoFire=function(){"use strict";var e=function(e){return e*Math.PI/180},n=function(n,t){var r,i,o=n[0],u=n[1],a=t[0],c=t[1],f=6371,d=e(a-o),s=e(c-u);return r=Math.sin(d/2)*Math.sin(d/2)+Math.cos(e(o))*Math.cos(e(a))*Math.sin(s/2)*Math.sin(s/2),i=2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r)),f*i},t=function(e,n){var t={min:-90,max:90},r={min:-180,max:180},i=e[0],o=e[1],u="",a=0,c=0,f=1;if(n=Math.min(n||12,22),i<t.min||i>t.max)throw"Invalid latitude specified! ("+i+")";if(o<r.min||o>r.max)throw"Invalid longitude specified! ("+o+")";for(;u.length<n;){var d=f?o:i,s=f?r:t,l=(s.min+s.max)/2;d>l?(a=(a<<1)+1,s.min=l):(a=(a<<1)+0,s.max=l),f=!f,4>c?c++:(c=0,u+="0123456789bcdefghjkmnpqrstuvwxyz"[a],a=0)}return u},r=function(e){if(this.cancel=function(){"undefined"!=typeof n&&(n(),n=void 0)},"function"!=typeof e)throw new Error("GeoCallbackRegistration.cancel() callback must be a function.");var n=e},i=function(e,i){function o(e){for(var n in e)if(e.hasOwnProperty(n)&&"center"!==n&&"radius"!==n)throw new Error('Unexpected "'+n+'" attribute found in query criteria.');if("undefined"!=typeof e.center){if(!(e.center instanceof Array&&2===e.center.length))throw new Error('Invalid "center" attribute specified for query criteria. Expected array of length 2, got '+e._center.length);var r=e.center[0],i=e.center[1];if("number"!=typeof r||-90>r||r>90)throw new Error('Invalid "center" attribute specified for query criteria. Latitude must be a number within the range [-90, 90]');if("number"!=typeof i||-180>i||i>180)throw new Error('Invalid "center" attribute specified for query criteria. Longitude must be a number within the range [-180, 180]')}if("undefined"!=typeof e.radius&&("number"!=typeof e.radius||e.radius<0))throw new Error('Invalid "radius" attribute specified for query criteria. Radius must be a number greater than or equal to 0.');a=e.center,f=t(e.center,12),c=e.radius}function u(e,t){var r=void 0!==l[e],i=n(t,a)<=c;!r&&i?(s.key_entered.forEach(function(n){n(e,t)}),l[e]=t):r&&!i?(s.key_left.forEach(function(n){n(e,t)}),delete l[e]):r&&(s.key_moved.forEach(function(n){n(e,t)}),l[e]=t)}if(this.getResults=function(){return new RSVP.Promise(function(e){var n=[];for(var t in l)l.hasOwnProperty(t)&&n.push({key:t,location:l[t]});e(n)})},this.on=function(e,n){if(-1===["key_entered","key_left","key_moved"].indexOf(e))throw new Error('Event type must be "key_entered", "key_left", or "key_moved"');if("function"!=typeof n)throw new Error("Event callback must be a function.");if(s[e].push(n),"key_entered"===e)for(var t in l)l.hasOwnProperty(t)&&n(t,l[t]);return new r(function(){s[e].splice(s[e].indexOf(n),1)})},this.cancel=function(){s={key_entered:[],key_left:[],key_moved:[]},d.child("indices").off(),d.child("locations").off()},this.updateQueryCriteria=function(e){o(e);for(var n in h)h.hasOwnProperty(n)&&u(n,h[n])},this.getCenter=function(){return a},this.getRadius=function(){return c},"undefined"==typeof i.center)throw new Error('No "center" attribute specified for query criteria.');if("undefined"==typeof i.radius)throw new Error('No "radius" attribute specified for query criteria.');var a,c,f,d=e,s={key_entered:[],key_left:[],key_moved:[]},l={},h={};o(i),d.child("indices").on("child_added",function(e){var n=e.val();d.child("locations/"+n).once("value",function(e){var t=e.val().split(",").map(Number);h[n]=t,u(n,t)})}),d.child("locations").on("child_removed",function(e){var n=e.name();void 0!==l[n]&&(s.key_left.forEach(function(e){e(n,h[n])}),delete h[n])})},o=function(e){function n(e){return new RSVP.Promise(function(n,t){var r;"string"!=typeof e&&"number"!=typeof e&&(r="key must be a string or a number"),void 0!==r?t("Error: Invalid key '"+e+"': "+r):n()})}function r(e){return new RSVP.Promise(function(n,t){var r;if(null===e&&n(),e instanceof Array&&2===e.length){var i=e[0],o=e[1];"number"!=typeof i||-90>i||i>90?r="latitude must be a number within the range [-90, 90]":("number"!=typeof o||-180>o||o>180)&&(r="longitude must be a number within the range [-180, 180]")}else r="expected 2 values, got "+e.length;void 0!==r?t("Erorr: Invalid location ["+e+"]: "+r):n()})}function o(e,n){return new RSVP.Promise(function(r,i){null===n&&r(),a.child("indices/"+t(n,12)).set(e,function(e){e?i("Error: Firebase synchronization failed: "+e):r()})})}function u(e,n){function r(){return new RSVP.Promise(function(n,r){void 0!==c[e]?a.child("indices/"+t(c[e].split(",").map(Number),12)).remove(function(e){e?r("Error: Firebase synchronization failed: "+e):n()}):n()})}function i(){return new RSVP.Promise(function(t,r){a.child("locations/"+e).set(n?n.toString():null,function(e){e?r("Error: Firebase synchronization failed: "+e):t()})})}return r().then(function(){return i()})}this.set=function(e,t){return RSVP.all([n(e),r(t)]).then(function(){return u(e.toString(),t)}).then(function(){return o(e.toString(),t)})},this.get=function(e){return n(e).then(function(){return new RSVP.Promise(function(n,t){a.child("locations/"+e.toString()).once("value",function(e){n(e.val()?e.val().split(",").map(Number):null)},function(e){t("Error: Firebase synchronization failed: "+e)})})})},this.remove=function(e){return this.set(e,null)},this.query=function(e){return new i(a,e)};var a=e,c={};a.child("locations").on("child_added",function(e){c[e.name()]=e.val()}),a.child("locations").on("child_removed",function(e){delete c[e.name()]})};return o}();"undefined"!=typeof module&&(module.exports=GeoFire);