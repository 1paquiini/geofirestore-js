if("undefined"!=typeof module&&"undefined"!=typeof process)var RSVP=require("RSVP");var GeoFire=function(){"use strict";var e=function(e){if(this.cancel=function(){"undefined"!=typeof n&&(n(),n=void 0)},"function"!=typeof e)throw new Error("GeoCallbackRegistration.cancel() callback must be a function.");var n=e},n=function(e){function n(e){return new RSVP.Promise(function(n,r){var t;"string"!=typeof e&&"number"!=typeof e&&(t="key must be a string or a number"),void 0!==t?r('Error: Invalid key "'+e+'": '+t):n()})}function r(e){return new RSVP.Promise(function(n,r){var t;if(null===e&&n(),"[object Array]"!==Object.prototype.toString.call(e)||2!==e.length)t="expected array of length 2, got "+e.length;else{var i=e[0],o=e[1];"number"!=typeof i?t="latitude must be a number":-90>i||i>90?t="latitude must be within the range [-90, 90]":"number"!=typeof o?t="longitude must be a number":(-180>o||o>180)&&(t="longitude must be within the range [-180, 180]")}void 0!==t?r("Error: Invalid location ["+e+"]: "+t):n()})}function t(e,n){return new RSVP.Promise(function(r,t){c.child("locations/"+e).once("value",function(i){var a=i.val();null===a?r(null!==n):(a=a.split(",").map(Number),null!==n&&n[0]===a[0]&&n[1]===a[1]&&r(!1),c.child("indices/"+d(a,o)+e).remove(function(e){e?t("Error: Firebase synchronization failed: "+e):r(!0)}))},function(e){t("Error: Firebase synchronization failed: "+e)})})}function i(e,n){return new RSVP.Promise(function(r,t){c.child("locations/"+e).set(n?n.toString():null,function(e){e?t("Error: Firebase synchronization failed: "+e):r()})})}function a(e,n){return new RSVP.Promise(function(r,t){null===n?r():c.child("indices/"+d(n,o)+e).set(!0,function(e){e?t("Error: Firebase synchronization failed: "+e):r()})})}function u(e){return new RSVP.Promise(function(n,r){c.child("locations/"+e.toString()).once("value",function(e){n(e.val()?e.val().split(",").map(Number):null)},function(e){r("Error: Firebase synchronization failed: "+e)})})}this.set=function(e,o){return new RSVP.all([n(e),r(o)]).then(function(){return t(e,o)}).then(function(n){return n===!0?new RSVP.all([i(e,o),a(e,o)]):new RSVP.Promise(function(e){e()})})},this.get=function(e){return n(e).then(function(){return u(e)})},this.remove=function(e){return this.set(e,null)},this.query=function(e){return new s(c,e)};var c=e},r="0123456789bcdefghjkmnpqrstuvwxyz",t={north:{even:"p0r21436x8zb9dcf5h7kjnmqesgutwvy",odd:"bc01fg45238967deuvhjyznpkmstqrwx"},east:{even:"bc01fg45238967deuvhjyznpkmstqrwx",odd:"p0r21436x8zb9dcf5h7kjnmqesgutwvy"},south:{even:"14365h7k9dcfesgujnmqp0r2twvyx8zb",odd:"238967debc01fg45kmstqrwxuvhjyznp"},west:{even:"238967debc01fg45kmstqrwxuvhjyznp",odd:"14365h7k9dcfesgujnmqp0r2twvyx8zb"}},i={north:{even:"prxz",odd:"bcfguvyz"},east:{even:"bcfguvyz",odd:"prxz"},south:{even:"028b",odd:"0145hjnp"},west:{even:"0145hjnp",odd:"028b"}},o=12,a=function(e){return e*Math.PI/180},u=function(e,n){var r=6371,t=a(n[0]-e[0]),i=a(n[1]-e[1]),o=Math.sin(t/2)*Math.sin(t/2)+Math.cos(a(e[0]))*Math.cos(a(n[0]))*Math.sin(i/2)*Math.sin(i/2),u=2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o));return r*u},c=function(e,n){var o=e.charAt(e.length-1),a=e.length%2?"odd":"even",u=e.substring(0,e.length-1);if(-1!==i[n][a].indexOf(o)){if(u.length<=0)return"";u=c(u,n)}return u+r[t[n][a].indexOf(o)]},f=function(e){var n=[];return n.push(c(e,"north")),n.push(c(e,"south")),n.push(c(e,"east")),n.push(c(e,"west")),n.push(c(n[0],"east")),n.push(c(n[0],"west")),n.push(c(n[1],"east")),n.push(c(n[1],"west")),n},d=function(e,n){var t={min:-90,max:90},i={min:-180,max:180},o=e[0],a=e[1],u="",c=0,f=0,d=1;if(n=Math.min(n||12,22),o<t.min||o>t.max)throw new Error("Invalid latitude specified in encodeGeohash(): "+o);if(a<i.min||a>i.max)throw new Error("Invalid longitude specified in encodeGeohash(): "+a);for(;u.length<n;){var s=d?a:o,l=d?i:t,h=(l.min+l.max)/2;s>h?(c=(c<<1)+1,l.min=h):(c=(c<<1)+0,l.max=h),d=!d,4>f?f++:(f=0,u+=r[c],c=0)}return u},s=function(n,r){function t(e){for(var n in e)if(e.hasOwnProperty(n)&&"center"!==n&&"radius"!==n)throw new Error('Unexpected "'+n+'" attribute found in query criteria.');if("undefined"!=typeof e.center){if("[object Array]"!==Object.prototype.toString.call(e.center)||2!==e.center.length)throw new Error('Invalid "center" attribute specified for query criteria. Expected array of length 2, got '+e._center.length);var r=e.center[0],t=e.center[1];if("number"!=typeof r)throw new Error('Invalid "center" attribute specified for query criteria. Latitude must be a number.');if(-90>r||r>90)throw new Error('Invalid "center" attribute specified for query criteria. Latitude must be within the range [-90, 90].');if("number"!=typeof t)throw new Error('Invalid "center" attribute specified for query criteria. Longitude must be a number.');if(-180>t||t>180)throw new Error('Invalid "center" attribute specified for query criteria. Longitude must be within the range [-180, 180].')}if("undefined"!=typeof e.radius){if("number"!=typeof e.radius)throw new Error('Invalid "radius" attribute specified for query criteria. Radius must be a number.');if(e.radius<0)throw new Error('Invalid "radius" attribute specified for query criteria. Radius must be greater than or equal to 0.')}c=e.center||c,s=e.radius||s}function i(e,n){var r=u(n,c),t=void 0!==m[e],i=s>=r;!t&&i&&(m[e]={location:n,distanceFromCenter:r},h.key_entered.forEach(function(t){t(e,n,r)}),m[e].valueCallback=l.child("locations/"+e).on("value",function(r){var t=r.val()?r.val().split(",").map(Number):null;if(null===t||t[0]!==n[0]||t[1]!==n[1]){var i=null===t?null:u(t,c),o=null===t?!1:s>=i;o?(h.key_moved.forEach(function(n){n(e,t,i)}),m[e].location=t,m[e].distanceFromCenter=i):(l.child("locations/"+e).off("value",m[e].valueCallback),h.key_exited.forEach(function(n){n(e,t,i)}),delete m[e])}})),y>0&&(y--,v&&0===y&&h.ready.forEach(function(e){e()}))}function a(){for(var e=[null,5003.771699005143,625.4714623756429,156.36786559391072,19.54598319923884,4.88649579980971,.6108119749762138],n=6;s>e[n];)n-=1;var r=d(c,o).substring(0,n),t=f(r);t.push(r),t=t.filter(function(e,n){return e.length>0&&t.indexOf(e)===n});for(var a in b)if(b.hasOwnProperty(a)){var u=t.indexOf(a);-1===u?(l.child("indices").off("child_added",b[a]),delete b[a]):t.splice(u,1)}for(var m=0,w=0,g=t.length;g>w;++w){var a=t[w].substring(0,n),k=a+"~",x=l.child("indices").startAt(null,a).endAt(null,k),E=x.on("child_added",function(e){v||y++;var n=e.name().slice(o);l.child("locations/"+n).once("value",function(e){var r=e.val().split(",").map(Number);p[n]=r,i(n,r)})});b[a]=E,x.once("value",function(){m++,v=m===t.length,v&&0===y&&h.ready.forEach(function(e){e()})})}}this.center=function(){return c},this.radius=function(){return s},this.updateCriteria=function(e){t(e);for(var n in m)if(m.hasOwnProperty(n)){var r=m[n];r.distanceFromCenter=u(r.location,c);var o=r.distanceFromCenter<=s;o||(h.key_exited.forEach(function(e){e(n,r.location,r.distanceFromCenter)}),l.child("locations/"+n).off("value",r.valueCallback),delete m[n])}for(n in p)p.hasOwnProperty(n)&&i(n,p[n]);v=!1,y=0,a()},this.on=function(n,r){if(-1===["ready","key_entered","key_exited","key_moved"].indexOf(n))throw new Error('Event type must be "key_entered", "key_exited", or "key_moved"');if("function"!=typeof r)throw new Error("Event callback must be a function.");if(h[n].push(r),"key_entered"===n)for(var t in m)if(m.hasOwnProperty(t)){var i=m[t];r(t,i.location,i.distanceFromCenter)}return"ready"===n&&v&&r(),new e(function(){h[n].splice(h[n].indexOf(r),1)})},this.cancel=function(){h={ready:[],key_entered:[],key_exited:[],key_moved:[]};for(var e in b)b.hasOwnProperty(e)&&l.child("indices").off("child_added",b[e]);for(var e in m)m.hasOwnProperty(e)&&l.child("locations/"+e).off("value",m[e].valueCallback);m=[]};var c,s,l=n,h={ready:[],key_entered:[],key_exited:[],key_moved:[]},v=!1,y=0,m={},p={},b={};if("undefined"==typeof r.center)throw new Error('No "center" attribute specified for query criteria.');if("undefined"==typeof r.radius)throw new Error('No "radius" attribute specified for query criteria.');t(r),a()};return n}();"undefined"!=typeof module&&(module.exports=GeoFire);