var GeoFire=function(){"use strict";var e=function(e){if(this.cancel=function(){"undefined"!=typeof n&&(n(),n=void 0)},"function"!=typeof e)throw new Error("GeoCallbackRegistration.cancel() callback must be a function.");var n=e},n=12,t=function(e){function t(e){return new RSVP.Promise(function(n,t){var r;"string"!=typeof e&&"number"!=typeof e&&(r="key must be a string or a number"),void 0!==r?t('Error: Invalid key "'+e+'": '+r):n()})}function r(e){return new RSVP.Promise(function(n,t){var r;if(null===e&&n(),"[object Array]"!==Object.prototype.toString.call(e)||2!==e.length)r="expected array of length 2, got "+e.length;else{var i=e[0],o=e[1];"number"!=typeof i?r="latitude must be a number":-90>i||i>90?r="latitude must be within the range [-90, 90]":"number"!=typeof o?r="longitude must be a number":(-180>o||o>180)&&(r="longitude must be within the range [-180, 180]")}void 0!==r?t("Error: Invalid location ["+e+"]: "+r):n()})}function i(e,t){return new RSVP.Promise(function(r,i){d.child("locations/"+e).once("value",function(o){var u=o.val();null===u?r(null!==t):(u=u.split(",").map(Number),null!==t&&t[0]===u[0]&&t[1]===u[1]&&r(!1),d.child("indices/"+f(u,n)+e).remove(function(e){e?i("Error: Firebase synchronization failed: "+e):r(!0)}))},function(e){i("Error: Firebase synchronization failed: "+e)})})}function o(e,n){return new RSVP.Promise(function(t,r){d.child("locations/"+e).set(n?n.toString():null,function(e){e?r("Error: Firebase synchronization failed: "+e):t()})})}function u(e,t){return new RSVP.Promise(function(r,i){null===t?r():d.child("indices/"+f(t,n)+e).set(!0,function(e){e?i("Error: Firebase synchronization failed: "+e):r()})})}function a(e){return new RSVP.Promise(function(n,t){d.child("locations/"+e.toString()).once("value",function(e){n(e.val()?e.val().split(",").map(Number):null)},function(e){t("Error: Firebase synchronization failed: "+e)})})}this.set=function(e,n){return new RSVP.all([t(e),r(n)]).then(function(){return i(e,n)}).then(function(t){return t===!0?new RSVP.all([o(e,n),u(e,n)]):new RSVP.Promise(function(e){e()})})},this.get=function(e){return t(e).then(function(){return a(e)})},this.remove=function(e){return this.set(e,null)},this.query=function(e){return new s(d,e)};var d=e},r="0123456789bcdefghjkmnpqrstuvwxyz",i={north:{even:"p0r21436x8zb9dcf5h7kjnmqesgutwvy",odd:"bc01fg45238967deuvhjyznpkmstqrwx"},east:{even:"bc01fg45238967deuvhjyznpkmstqrwx",odd:"p0r21436x8zb9dcf5h7kjnmqesgutwvy"},south:{even:"14365h7k9dcfesgujnmqp0r2twvyx8zb",odd:"238967debc01fg45kmstqrwxuvhjyznp"},west:{even:"238967debc01fg45kmstqrwxuvhjyznp",odd:"14365h7k9dcfesgujnmqp0r2twvyx8zb"}},o={north:{even:"prxz",odd:"bcfguvyz"},east:{even:"bcfguvyz",odd:"prxz"},south:{even:"028b",odd:"0145hjnp"},west:{even:"0145hjnp",odd:"028b"}},u=function(e){return e*Math.PI/180},a=function(e,n){var t=6371,r=u(n[0]-e[0]),i=u(n[1]-e[1]),o=Math.sin(r/2)*Math.sin(r/2)+Math.cos(u(e[0]))*Math.cos(u(n[0]))*Math.sin(i/2)*Math.sin(i/2),a=2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o));return t*a},d=function(e,n){var t=e.charAt(e.length-1),u=e.length%2?"odd":"even",a=e.substring(0,e.length-1);if(-1!==o[n][u].indexOf(t)){if(a.length<=0)return"";a=d(a,n)}return a+r[i[n][u].indexOf(t)]},c=function(e){var n=[];return n.push(d(e,"north")),n.push(d(e,"south")),n.push(d(e,"east")),n.push(d(e,"west")),n.push(d(n[0],"east")),n.push(d(n[0],"west")),n.push(d(n[1],"east")),n.push(d(n[1],"west")),n},f=function(e,n){var t={min:-90,max:90},i={min:-180,max:180},o=e[0],u=e[1],a="",d=0,c=0,f=1;if(n=Math.min(n||12,22),o<t.min||o>t.max)throw new Error("Invalid latitude specified in encodeGeohash(): "+o);if(u<i.min||u>i.max)throw new Error("Invalid longitude specified in encodeGeohash(): "+u);for(;a.length<n;){var s=f?u:o,l=f?i:t,h=(l.min+l.max)/2;s>h?(d=(d<<1)+1,l.min=h):(d=(d<<1)+0,l.max=h),f=!f,4>c?c++:(c=0,a+=r[d],d=0)}return a},s=function(t,r){function i(e){for(var n in e)if(e.hasOwnProperty(n)&&"center"!==n&&"radius"!==n)throw new Error('Unexpected "'+n+'" attribute found in query criteria.');if("undefined"!=typeof e.center){if("[object Array]"!==Object.prototype.toString.call(e.center)||2!==e.center.length)throw new Error('Invalid "center" attribute specified for query criteria. Expected array of length 2, got '+e._center.length);var t=e.center[0],r=e.center[1];if("number"!=typeof t)throw new Error('Invalid "center" attribute specified for query criteria. Latitude must be a number.');if(-90>t||t>90)throw new Error('Invalid "center" attribute specified for query criteria. Latitude must be within the range [-90, 90].');if("number"!=typeof r)throw new Error('Invalid "center" attribute specified for query criteria. Longitude must be a number.');if(-180>r||r>180)throw new Error('Invalid "center" attribute specified for query criteria. Longitude must be within the range [-180, 180].')}if("undefined"!=typeof e.radius){if("number"!=typeof e.radius)throw new Error('Invalid "radius" attribute specified for query criteria. Radius must be a number.');if(e.radius<0)throw new Error('Invalid "radius" attribute specified for query criteria. Radius must be greater than or equal to 0.')}h=e.center||h,v=e.radius||v}function o(e,n){var t=a(n,h),r=void 0!==y[e],i=v>=t;if(i){r?(l.key_moved.forEach(function(r){r(e,n,t)}),y[e]=n):(l.key_entered.forEach(function(r){r(e,n,t)}),y[e]=n);var o=s.child("locations/"+e).on("value",function(t){var r=t.val()?t.val().split(",").map(Number):null;(null===r||r[0]!==n[0]||r[1]!==n[1])&&(s.child("locations/"+e).off("value",o),u(e,r))})}_numChildAddedEventsToProcess>0&&(_numChildAddedEventsToProcess--,_valueEventFired&&0===_numChildAddedEventsToProcess&&l.ready.forEach(function(e){e()}))}function u(e,n){var t=void 0!==y[e],r=null===n?null:a(n,h),i=null===n?!1:v>=r;t&&!i&&(l.key_exited.forEach(function(t){t(e,n,r)}),delete y[e])}function d(){for(var e=[null,5003.771699005143,625.4714623756429,156.36786559391072,19.54598319923884,4.88649579980971,.6108119749762138],t=6;v>e[t];)t-=1;var r=f(h,n).substring(0,t),i=c(r);i.push(r),i=i.filter(function(e,n){return e.length>0&&i.indexOf(e)===n});for(var u=0,a=0,d=i.length;d>a;++a){var l=i[a].substring(0,t),y=l+"~",p=s.child("indices").startAt(null,l).endAt(null,y),b=p.on("child_added",function(e){_valueEventFired||_numChildAddedEventsToProcess++;var t=e.name().slice(n);s.child("locations/"+t).once("value",function(e){var n=e.val().split(",").map(Number);o(t,n,"child_added")})});m.push(b),p.once("value",function(){u++,u===i.length&&(_valueEventFired=!0)})}}this.on=function(n,t){if(-1===["ready","key_entered","key_exited","key_moved"].indexOf(n))throw new Error('Event type must be "key_entered", "key_exited", or "key_moved"');if("function"!=typeof t)throw new Error("Event callback must be a function.");if(l[n].push(t),"key_entered"===n)for(var r in y)y.hasOwnProperty(r)&&t(r,y[r],a(y[r],h));return"ready"===n&&_valueEventFired&&t(),new e(function(){l[n].splice(l[n].indexOf(t),1)})},this.cancel=function(){l={ready:[],key_entered:[],key_exited:[],key_moved:[]},m.forEach(function(e){s.child("indices").off("child_added",e)}),m=[]},this.updateCriteria=function(e){_valueEventFired=!1,_numChildAddedEventsToProcess=0,i(e),m.forEach(function(e){s.child("indices").off("child_added",e)}),m=[];for(var n in y)y.hasOwnProperty(n)&&u(n,y[n]);d()},this.center=function(){return h},this.radius=function(){return v};var s=t,l={ready:[],key_entered:[],key_exited:[],key_moved:[]};_valueEventFired=!1,_numChildAddedEventsToProcess=0;var h,v,m=[],y={};if("undefined"==typeof r.center)throw new Error('No "center" attribute specified for query criteria.');if("undefined"==typeof r.radius)throw new Error('No "radius" attribute specified for query criteria.');i(r),d()};return t}();"undefined"!=typeof module&&(module.exports=GeoFire);