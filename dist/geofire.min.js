if("undefined"!=typeof module&&"undefined"!=typeof process)var RSVP=require("RSVP");var GeoFire=function(){"use strict";var e=function(e){if(this.cancel=function(){"undefined"!=typeof n&&(n(),n=void 0)},"function"!=typeof e)throw new Error("GeoCallbackRegistration.cancel() callback must be a function.");var n=e},n=function(e){function n(e,n){return new RSVP.Promise(function(t,i){f.child("l/"+e).once("value",function(o){var a=o.val();null===a?t(null!==n):(a=a.split(",").map(Number),null!==n&&n[0]===a[0]&&n[1]===a[1]?t(!1):f.child("i/"+d(a,r)+e).remove(function(e){e?i("Error: Firebase synchronization failed: "+e):t(!0)}))},function(e){i("Error: Firebase synchronization failed: "+e)})})}function t(e,n){return new RSVP.Promise(function(r,t){f.child("l/"+e).set(n?n.toString():null,function(e){e?t("Error: Firebase synchronization failed: "+e):r()})})}function i(e,n){return new RSVP.Promise(function(t,i){null===n?t():f.child("i/"+d(n,r)+e).set(!0,function(e){e?i("Error: Firebase synchronization failed: "+e):t()})})}function o(e){return new RSVP.Promise(function(n,r){f.child("l/"+e).once("value",function(e){n(e.val()?e.val().split(",").map(Number):null)},function(e){r("Error: Firebase synchronization failed: "+e)})})}this.set=function(e,r){return a(e),null!==r&&u(r),n(e,r).then(function(n){return n===!0?new RSVP.all([t(e,r),i(e,r)]):new RSVP.Promise(function(e){e()})})},this.get=function(e){return a(e),o(e)},this.remove=function(e){return this.set(e,null)},this.query=function(e){return new y(f,e)};var f=e},r=12,t="0123456789bcdefghjkmnpqrstuvwxyz",i={north:{even:"p0r21436x8zb9dcf5h7kjnmqesgutwvy",odd:"bc01fg45238967deuvhjyznpkmstqrwx"},east:{even:"bc01fg45238967deuvhjyznpkmstqrwx",odd:"p0r21436x8zb9dcf5h7kjnmqesgutwvy"},south:{even:"14365h7k9dcfesgujnmqp0r2twvyx8zb",odd:"238967debc01fg45kmstqrwxuvhjyznp"},west:{even:"238967debc01fg45kmstqrwxuvhjyznp",odd:"14365h7k9dcfesgujnmqp0r2twvyx8zb"}},o={north:{even:"prxz",odd:"bcfguvyz"},east:{even:"bcfguvyz",odd:"prxz"},south:{even:"028b",odd:"0145hjnp"},west:{even:"0145hjnp",odd:"028b"}},a=function(e){var n;if("string"!=typeof e?n="key must be a string":0===e.length?n="key cannot be the empty string":1+r+e.length>755?n="key is too long to be stored in Firebase":[".","$","[","]","#"].forEach(function(r){-1!==e.indexOf(r)&&(n='key cannot contain "'+r+'" character')}),"undefined"!=typeof n)throw new Error('Invalid GeoFire key "'+e+'": '+n)},u=function(e){var n;if("[object Array]"!==Object.prototype.toString.call(e))n="location must be an array";else if(2!==e.length)n="expected array of length 2, got length "+e.length;else{var r=e[0],t=e[1];"number"!=typeof r?n="latitude must be a number":-90>r||r>90?n="latitude must be within the range [-90, 90]":"number"!=typeof t?n="longitude must be a number":(-180>t||t>180)&&(n="longitude must be within the range [-180, 180]")}if("undefined"!=typeof n)throw new Error('Invalid GeoFire location "['+e+']": '+n)},f=function(e){var n;if("string"!=typeof e)n="geohash must be a string";else if(0===e.length)n="geohash cannot be the empty string";else for(var r=0,i=e.length;i>r;++r)-1===t.indexOf(e[r])&&(n='geohash cannot contain "'+e[r]+'"');if("undefined"!=typeof n)throw new Error('Invalid GeoFire geohash "'+e+'": '+n)},c=function(e){if("number"!=typeof e)throw new Error("Error: degrees must be a number");return e*Math.PI/180},s=function(e,n){u(e),u(n);var r=6371,t=c(n[0]-e[0]),i=c(n[1]-e[1]),o=Math.sin(t/2)*Math.sin(t/2)+Math.cos(c(e[0]))*Math.cos(c(n[0]))*Math.sin(i/2)*Math.sin(i/2),a=2*Math.atan2(Math.sqrt(o),Math.sqrt(1-o));return r*a},d=function(e,n){if(u(e),"undefined"!=typeof n){if("number"!=typeof n)throw new Error("precision must be a number");if(0>=n)throw new Error("precision must be greater than 0");if(n>22)throw new Error("precision cannot be greater than 22");if(Math.round(n)!==n)throw new Error("precision must be an integer")}n=n||r;for(var i={min:-90,max:90},o={min:-180,max:180},a="",f=0,c=0,s=1;a.length<n;){var d=s?e[1]:e[0],l=s?o:i,h=(l.min+l.max)/2;d>h?(f=(f<<1)+1,l.min=h):(f=(f<<1)+0,l.max=h),s=!s,4>c?c++:(c=0,a+=t[f],f=0)}return a},l=function(e,n){if(f(e),-1===["north","south","east","west"].indexOf(n))throw new Error('Error: direction must be one of "north", "south", "east", or "west"');var r=e.charAt(e.length-1),a=e.length%2?"odd":"even",u=e.substring(0,e.length-1);if(-1!==o[n][a].indexOf(r)){if(u.length<=0)return"";u=l(u,n)}return u+t[i[n][a].indexOf(r)]},h=function(e){f(e);var n=[];return n.push(l(e,"north")),n.push(l(e,"south")),n.push(l(e,"east")),n.push(l(e,"west")),""!==n[0]&&(n.push(l(n[0],"east")),n.push(l(n[0],"west"))),""!==n[1]&&(n.push(l(n[1],"east")),n.push(l(n[1],"west"))),n},y=function(n,t){function i(e){for(var n in e)if(e.hasOwnProperty(n)&&"center"!==n&&"radius"!==n)throw new Error('Unexpected "'+n+'" attribute found in query criteria.');if("undefined"!=typeof e.center&&u(e.center),"undefined"!=typeof e.radius){if("number"!=typeof e.radius)throw new Error('Invalid "radius" attribute specified for query criteria. Radius must be a number.');if(e.radius<0)throw new Error('Invalid "radius" attribute specified for query criteria. Radius must be greater than or equal to 0.')}c=e.center||c,l=e.radius||l}function o(e,n){console.assert("undefined"!=typeof b[e],"Location should be in location queried dictionary");var r=s(n,c),t=b[e].isInQuery===!0,i=l>=r;b[e].distanceFromCenter=r,b[e].isInQuery=i,!t&&i&&v.key_entered.forEach(function(t){t(e,n,r)}),m>0&&(m--,p&&0===m&&v.ready.forEach(function(e){e()}))}function a(e){var n=y.child("l/"+e).on("value",function(r){var t=r.val()?r.val().split(",").map(Number):null;"undefined"==typeof b[e]||b[e].isInQuery===!1?null===t?(y.child("l/"+e).off("value",b[e].valueCallback),delete b[e]):(b[e]={location:t,isInQuery:!1,valueCallback:n},o(e,t)):(null===t||t[0]!==b[e].location[0]||t[1]!==b[e].location[1])&&(b[e].location=t,b[e].distanceFromCenter=null===t?null:s(t,c),b[e].isInQuery=null===t?!1:b[e].distanceFromCenter<=l,b[e].isInQuery?v.key_moved.forEach(function(n){n(e,t,b[e].distanceFromCenter)}):(v.key_exited.forEach(function(n){n(e,t,b[e].distanceFromCenter)}),null===t&&(y.child("l/"+e).off("value",b[e].valueCallback),delete b[e])))})}function f(){for(var e=[null,5003.771699005143,625.4714623756429,156.36786559391072,19.54598319923884,4.88649579980971,.6108119749762138],n=6;l>e[n];)n-=1;var t=d(c,r).substring(0,n),i=h(t);i.push(t),i=i.filter(function(e,n){return e.length>0&&i.indexOf(e)===n});for(var o in w)if(w.hasOwnProperty(o)){var u=i.indexOf(o);-1===u?(setTimeout(function(){y.child("i").off("child_added",w[o])},1e3),delete w[o]):i.splice(u,1)}for(var f=0,s=0,g=i.length;g>s;++s){var k=i[s].substring(0,n),x=k+"~",E=y.child("i").startAt(null,k).endAt(null,x),q=E.on("child_added",function(e){p||m++;var n=e.name().slice(r);"undefined"==typeof b[n]&&a(n)});w[k]=q,E.once("value",function(){f++,p=f===i.length,p&&0===m&&v.ready.forEach(function(e){e()})})}}this.center=function(){return c},this.radius=function(){return l},this.updateCriteria=function(e){i(e);for(var n in b)if(b.hasOwnProperty(n)){var r=b[n];if(r.isInQuery){r.distanceFromCenter=s(r.location,c);var t=r.distanceFromCenter<=l;t||(v.key_exited.forEach(function(e){e(n,r.location,r.distanceFromCenter)}),b[n].isInQuery=!1)}else o(n,b[n].location)}p=!1,m=0,f()},this.on=function(n,r){if(-1===["ready","key_entered","key_exited","key_moved"].indexOf(n))throw new Error('Event type must be "key_entered", "key_exited", or "key_moved"');if("function"!=typeof r)throw new Error("Event callback must be a function.");if(v[n].push(r),"key_entered"===n)for(var t in b)if(b.hasOwnProperty(t)){var i=b[t];i.isInQuery&&r(t,i.location,i.distanceFromCenter)}return"ready"===n&&p&&r(),new e(function(){v[n].splice(v[n].indexOf(r),1)})},this.cancel=function(){v={ready:[],key_entered:[],key_exited:[],key_moved:[]};for(var e in w)w.hasOwnProperty(e)&&y.child("i").off("child_added",w[e]);for(var n in b)b.hasOwnProperty(n)&&(y.child("l/"+n).off("value",b[n].valueCallback),delete b[n])};var c,l,y=n,v={ready:[],key_entered:[],key_exited:[],key_moved:[]},p=!1,m=0,b={},w={};if("undefined"==typeof t.center)throw new Error('No "center" attribute specified for query criteria.');if("undefined"==typeof t.radius)throw new Error('No "radius" attribute specified for query criteria.');i(t),f()};return n}();"undefined"!=typeof module&&(module.exports=GeoFire);